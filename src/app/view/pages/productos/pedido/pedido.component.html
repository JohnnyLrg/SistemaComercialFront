<section class="pedidos">
    <div class="container pb-5">
        <div style="padding-left: 20px;">
            <button class="boton-regresar" routerLink="/dashboard/products">regresar</button>
        </div>

        <div class="row">
            <!-- Vista simplificada para usuarios autenticados -->
            <div *ngIf="currentUser" class="col-8 formPedido">
                <h2>Finalizar Compra</h2>
                
                <!-- Datos del cliente (siempre mostrados para usuarios autenticados) -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>
                            Datos de Facturación
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Nombre:</strong> {{ getUserDisplayData().nombre }}</p>
                                <p><strong>DNI:</strong> {{ getUserDisplayData().dni }}</p>
                                <p><strong>Email:</strong> {{ getUserDisplayData().email }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Teléfono:</strong> {{ getUserDisplayData().telefono }}</p>
                                <p><strong>Dirección:</strong> {{ getUserDisplayData().direccion }}</p>
                            </div>
                        </div>
                        <div class="text-muted small">
                            <i class="fas fa-edit me-1"></i>
                            ¿Necesitas actualizar tus datos? Ve a <a routerLink="/customer-profile" class="text-primary">Mi Perfil</a>
                        </div>
                    </div>
                </div>

                <!-- Método de pago -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-credit-card me-2"></i>
                            Método de Pago
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="radio-inputs">
                            <label *ngFor="let forma of formasPago">
                                <input class="radio-input" type="radio" name="metodoPago" [value]="forma.Formas_PagoCodigo" [(ngModel)]="selectedPaymentMethod" required>
                                <span class="radio-tile">
                                    <i class="fas" [ngClass]="{
                                        'fa-money-bill': forma.Formas_Pagonombre.toLowerCase().includes('efectivo'),
                                        'fa-credit-card': forma.Formas_Pagonombre.toLowerCase().includes('tarjeta'),
                                        'fa-university': forma.Formas_Pagonombre.toLowerCase().includes('transferencia'),
                                        'fa-wallet': !forma.Formas_Pagonombre.toLowerCase().includes('efectivo') && !forma.Formas_Pagonombre.toLowerCase().includes('tarjeta') && !forma.Formas_Pagonombre.toLowerCase().includes('transferencia')
                                    }" class="me-2"></i>
                                    <span class="radio-label">{{ forma.Formas_Pagonombre }}</span>
                                </span>
                            </label>
                        </div>
                        <div *ngIf="!selectedPaymentMethod && showPaymentError" class="text-danger mt-2">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Por favor, selecciona un método de pago
                        </div>
                    </div>
                </div>

                <!-- Botón de pago -->
                <button class="btn btn-success btn-lg w-100 mb-3" (click)="procesarPago()">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Pagar Ahora - S/. {{ calcularTotal() }}
                </button>
                
                <div class="text-center">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt me-1"></i>
                        Tu información está protegida y segura
                    </small>
                </div>
            </div>

            <!-- Vista para usuarios no autenticados: redirigir al login -->
            <div *ngIf="!currentUser" class="col-8 formPedido">
                <div class="alert alert-warning text-center" role="alert">
                    <i class="fas fa-lock fa-3x mb-3"></i>
                    <h4>Inicia sesión para continuar</h4>
                    <p>Necesitas una cuenta para finalizar tu compra</p>
                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-primary" (click)="goToLogin()">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            Iniciar Sesión
                        </button>
                        <button class="btn btn-outline-primary" (click)="goToRegister()">
                            <i class="fas fa-user-plus me-2"></i>
                            Crear Cuenta
                        </button>
                    </div>
                </div>
            </div>
            <!-- Resumen de la compra -->
            <div class="col-4">
                <div class="card CompraResumen">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Resumen de Compra
                        </h5>
                    </div>
                    <div class="card-body">
                        @for (producto of productosCarrito; track $index) {
                        <div class="mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <img class="imgProductos" [src]="producto.ProductoFoto" alt="producto" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{producto.ProductoNombre}}</h6>
                                    <small class="text-muted">{{producto.ProductoDescripcion}}</small>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <span class="fw-bold">Cantidad: {{ producto.quantity }}</span>
                                        <span class="text-primary fw-bold">S/. {{ (producto.ProductoPrecio * producto.quantity!).toFixed(2) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @if ($index < productosCarrito.length - 1) {
                        <hr class="my-2">
                        }
                        }
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Total:</h5>
                            <h4 class="mb-0 text-success fw-bold">S/. {{calcularTotal()}}</h4>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>