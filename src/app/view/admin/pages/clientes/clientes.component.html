<div class="">
    <!-- <button title="filter" class="filter">
        <svg viewBox="0 0 512 512" height="1em">
            <path
                d="M0 416c0 17.7 14.3 32 32 32l54.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 448c17.7 0 32-14.3 32-32s-14.3-32-32-32l-246.7 0c-12.3-28.3-40.5-48-73.3-48s-61 19.7-73.3 48L32 384c-17.7 0-32 14.3-32 32zm128 0a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zM320 256a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm32-80c-32.8 0-61 19.7-73.3 48L32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l246.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48l54.7 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-54.7 0c-12.3-28.3-40.5-48-73.3-48zM192 128a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm73.3-64C253 35.7 224.8 16 192 16s-61 19.7-73.3 48L32 64C14.3 64 0 78.3 0 96s14.3 32 32 32l86.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 128c17.7 0 32-14.3 32-32s-14.3-32-32-32L265.3 64z">
            </path>
        </svg>
    </button> -->
    <button class="btn-buscar-cliente" (click)="activarBuscarClienteDni()">{{ mostrarBuscarCliente ? 'Ocultar Búsqueda' : 'Buscar Cliente' }}</button>
    @if (!this.mostrarBuscarCliente) {
        <h2 class="my-2 text-center">Lista de Clientes</h2>
        <div class="row">
            <!-- Lista de clientes -->
            <div [class.col-md-8]="selectedCliente" [class.col-md-12]="!selectedCliente" class="transition-width">
                <div class="columnasClientes">
                    <div *ngFor="let cliente of clientes" class="custom-col" (click)="seleccionarCliente(cliente)">
                        <div [class.selected]="cliente === selectedCliente" class="card mb-4 shadow-sm h-100">
                            <div class="card-header text-white">
                                <h5 class="card-title mb-0">{{ cliente.ClienteNombre }} {{ cliente.ClienteApellidos }}</h5>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <p class="card-text mb-1"><strong>DNI:</strong> {{ cliente.ClienteDni }}</p>
                                <p class="card-text mb-1"><strong>Dirección:</strong> {{ cliente.ClienteDireccion }}</p>
                                <p class="card-text mb-1"><strong>Email:</strong> {{ cliente.ClienteEmail }}</p>
                                <p class="card-text mb-1"><strong>Teléfono:</strong> {{ cliente.ClienteTelefono }}</p>
                                <p class="card-text mb-1"><strong>Compras totales:</strong> {{ cliente.TotalCompras }}</p>
                            </div>
                            <div class="card-footer text-muted">
                                Cliente desde: {{ formatFecha(cliente.ClienteFecha) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Estadísticas del cliente -->
            <div *ngIf="selectedCliente" class="col-md-4">
                <div class="stats-container">
                    <button class="btn btn-secondary mb-3" (click)="deseleccionarCliente()">Cerrar</button>
                    <h3>Estadísticas de {{ selectedCliente.ClienteNombre }} {{ selectedCliente.ClienteApellidos }}</h3>
                    <p><strong>Historial de compras:</strong></p>
    
                    @if (cargandoEstadisticas) {
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando estadísticas...</span>
                            </div>
                            <p class="mt-2">Cargando estadísticas completas...</p>
                        </div>
                    } @else {
                        <p>Cantidad de pedidos: {{selectedCliente.CantidadPedidos || 'Sin datos'}}</p>
                        <p>Categorías Compradas: {{selectedCliente.CategoriasMasCompradas || 'Sin datos'}}</p>
                        <p>Productos Comprados: {{selectedCliente.ProductosComprados || 'Sin datos'}}</p>
                        <p>Total de compras: ${{selectedCliente.TotalCompras || 0}}</p>
                    }
                </div>
            </div>
        </div>
    }@else {
        <div class="container mt-4">
  <h2 class="text-center mb-4">Buscar Cliente por DNI</h2>
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <div class="form-group mb-3">
            <label for="dniInput" class="form-label">Ingrese el DNI del cliente:</label>
            <input 
              id="dniInput" 
              type="text" 
              class="form-control" 
              placeholder="Ej: 72801397"
              [(ngModel)]="dniBusqueda"
              (keyup.enter)="buscarClientePorDni()"
            >
          </div>
          <div class="d-flex gap-2">
            <button 
              type="button" 
              class="btn btn-primary flex-fill" 
              (click)="buscarClientePorDni()"
              [disabled]="!dniBusqueda || dniBusqueda.length < 8"
            >
              Buscar
            </button>
            <button 
              type="button" 
              class="btn btn-secondary" 
              (click)="limpiarBusqueda()"
            >
              Limpiar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resultados de la búsqueda -->
  <div *ngIf="clienteBuscado" class="mt-4">
    <h3 class="text-center">Información del Cliente</h3>
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">{{ clienteBuscado.ClienteNombre }} {{ clienteBuscado.ClienteApellidos }}</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p><strong>DNI:</strong> {{ clienteBuscado.ClienteDni }}</p>
                <p><strong>Email:</strong> {{ clienteBuscado.ClienteEmail }}</p>
                <p><strong>Teléfono:</strong> {{ clienteBuscado.ClienteTelefono }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Dirección:</strong> {{ clienteBuscado.ClienteDireccion }}</p>
                <p><strong>Total de Pedidos:</strong> {{ clienteBuscado.Pedidos.length || 0 }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Historial de Pedidos -->
    <div *ngIf="clienteBuscado.Pedidos && clienteBuscado.Pedidos.length > 0" class="mt-4">
      <h4 class="text-center">Historial de Pedidos</h4>
      <div class="row">
        <div *ngFor="let pedido of clienteBuscado.Pedidos" class="col-md-6 mb-3">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span><strong>Pedido #{{ pedido.PedidoCodigo }}</strong></span>
              <span class="badge" 
                    [class.bg-warning]="pedido.PedidoEstado === 'Pendiente'"
                    [class.bg-success]="pedido.PedidoEstado === 'Entregado'"
                    [class.bg-danger]="pedido.PedidoEstado === 'Cancelado'">
                {{ pedido.PedidoEstado }}
              </span>
            </div>
            <div class="card-body">
              <p><strong>Fecha:</strong> {{ pedido.Pedidofecha }}</p>
              <p><strong>Total:</strong> S/. {{ pedido.Pedidototal }}</p>
              <div *ngIf="pedido.Detalles && pedido.Detalles.length > 0">
                <h6>Productos:</h6>
                <ul class="list-unstyled">
                  <li *ngFor="let detalle of pedido.Detalles" class="small">
                     {{ detalle.ProductoNombre }} ({{ detalle.DetallePedidoCantidad }}x) - S/. {{ detalle.DetallePedidoSubtotal }}
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensaje cuando no se encuentra el cliente -->
  <div *ngIf="mensajeBusqueda" class="mt-4">
    <div class="alert alert-info text-center">
      {{ mensajeBusqueda }}
    </div>
  </div>
</div>
    }
</div>
